<!DOCTYPE html>
<html>
<head>
  <title>Farm Polygon Capture (Offline)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    #map { height: 70vh; width: 100%; }
    button, input { margin: 5px; padding: 10px; font-size: 16px; }
  </style>
</head>
<body>

<h2>Offline Farm Mapper App</h2>
<input type="text" id="farmName" placeholder="Enter Farm Name" />
<button onclick="capturePoint()">Add Point</button>
<button onclick="exportGeoJSON()">Download GeoJSON</button>
<button onclick="exportCSV()">Download CSV</button>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
  let points = [];
  let markers = [];
  let poly = null;
  let map;

  function initializeMap(lat, lon) {
    map = L.map('map').setView([lat, lon], 18);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri'
    }).addTo(map);
    L.marker([lat, lon]).addTo(map).bindPopup("Start Location").openPopup();
  }

  function drawPolygon() {
    if (poly) map.removeLayer(poly);
    if (points.length >= 2) {
      poly = L.polyline([...points, points[0]], { color: 'green' }).addTo(map);
    }
  }

  function capturePoint() {
    navigator.geolocation.getCurrentPosition(pos => {
      const latlng = [pos.coords.latitude, pos.coords.longitude];
      points.push(latlng);

      const marker = L.marker(latlng, { draggable: true }).addTo(map);
      marker.on('drag', function(e) {
        const index = markers.indexOf(marker);
        const newLatLng = [e.latlng.lat, e.latlng.lng];
        points[index] = newLatLng;
        drawPolygon();
      });

      markers.push(marker);
      drawPolygon();
    }, err => alert("Failed to get location: " + err.message));
  }

  function exportGeoJSON() {
    if (points.length < 3) {
      alert("At least 3 points needed to export a polygon.");
      return;
    }
    const name = document.getElementById("farmName").value || "Unnamed Farm";
    const geojson = {
      type: "FeatureCollection",
      features: [{
        type: "Feature",
        properties: { name: name },
        geometry: {
          type: "Polygon",
          coordinates: [[...points.map(p => [p[1], p[0]]), [points[0][1], points[0][0]]]]
        }
      }]
    };

    const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = name.replace(/\s+/g, '_') + ".geojson";
    a.click();
    URL.revokeObjectURL(url);
  }

  function exportCSV() {
    if (points.length === 0) {
      alert("No points to export.");
      return;
    }
    const name = document.getElementById("farmName").value || "Unnamed Farm";
    let csvContent = "Latitude,Longitude\n";
    points.forEach(p => csvContent += `${p[0]},${p[1]}\n`);

    const blob = new Blob([csvContent], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = name.replace(/\s+/g, '_') + ".csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  // Center the map on the user's current location when the page loads
  window.onload = () => {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      initializeMap(lat, lon);
    }, err => {
      alert("Unable to access location. Showing already available location.");
      initializeMap(20.5937, 78.9629); // fallback to center of India
    });
  };


</script>
</body>
</html>
